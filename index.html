<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>查詢學號資料</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container py-5">
    <h2 class="text-center mb-4 fw-bold">查詢學號</h2>

    <div class="row justify-content-center mb-4">
      <div class="col-md-6">
        <div class="input-group">
          <input type="text" id="userIdInput" class="form-control" placeholder="請輸入學號" />
          <button class="btn btn-primary" onclick="submitQuery()">查詢</button>
        </div>
        <p class="text-center text-muted mt-2">請輸入學號後點擊查詢</p>
      </div>
    </div>

    <div id="resultCard" class="row justify-content-center" style="display: none;">
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title fw-bold" id="full_name"></h5>
            <p class="card-text mb-1"><strong>學院：</strong><span id="school"></span></p>
            <p class="card-text mb-1"><strong>學系：</strong><span id="department"></span></p>
            <p class="card-text mb-1"><strong>Email：</strong><span id="email"></span></p>
            <p class="card-text mb-1"><strong>狀態：</strong><span id="status"></span></p>
            <p class="card-text mb-1"><strong>到期日：</strong><span id="expiry_date"></span></p>
          </div>
        </div>
      </div>
    </div>

    <div id="noResultMsg" class="row justify-content-center text-danger fw-bold text-center" style="display: none;">
      <p>查無資料，請確認學號是否正確。</p>
    </div>
  </div>

  <script>
    function safeText(value) {
      return value && value !== "null" ? value : "N/A";
    }

    async function submitQuery() {
      const userId = document.getElementById('userIdInput').value.trim();
      if (!userId) return alert('請輸入學號');

      // 清空狀態
      document.getElementById('resultCard').style.display = 'none';
      document.getElementById('noResultMsg').style.display = 'none';

      try {
        const response = await fetch('https://n8n5150.zeabur.app/webhook/alma-user-query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();

        // 若查無資料或沒有必要欄位
        if (!data || Object.keys(data).length === 0 || !data.full_name) {
          document.getElementById('noResultMsg').style.display = 'block';
          return;
        }

        // 顯示資料
        document.getElementById('full_name').textContent = safeText(data.full_name);
        document.getElementById('school').textContent = safeText(data.school);
        document.getElementById('department').textContent = safeText(data.department);
        document.getElementById('email').textContent = safeText(data.email);
        document.getElementById('status').textContent = safeText(data.status);
        document.getElementById('expiry_date').textContent = safeText(data.expiry_date);

        document.getElementById('resultCard').style.display = 'block';

      } catch (error) {
        console.error('查詢發生錯誤:', error);
        document.getElementById('noResultMsg').style.display = 'block';
      }
    }
  </script>
</body>
</html>
